async function generatePDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p', 'pt', 'a4');
  const pageWidth = pdf.internal.pageSize.getWidth();
  const pageHeight = pdf.internal.pageSize.getHeight();
  let y = 40;
  const lineHeight = 22;

  function checkPageBreak(space = 60) {
    if (y + space > pageHeight - 40) {
      pdf.addPage();
      y = 40;
    }
  }

  function addField(label, value) {
    checkPageBreak(50);
    pdf.setFontSize(12);
    pdf.setFillColor(240, 240, 240);
    pdf.roundedRect(40, y, pageWidth - 80, lineHeight * 1.5, 6, 6, 'F');
    pdf.setTextColor(0, 0, 0);
    pdf.text(`${label}: ${value || ""}`, 50, y + lineHeight);
    y += lineHeight * 2;
  }

  function addHeading(title) {
    y += 10; // space above headings
    checkPageBreak(40);
    pdf.setFontSize(14);
    pdf.setFont(undefined, "bold");
    pdf.text(title, 40, y);
    pdf.setFont(undefined, "normal");
    y += lineHeight;
  }

  // Header image
  const headerImg = document.querySelector(".header-image img");
  if (headerImg) {
    const imgData = await fileToDataURL(await urlToFile(headerImg.src));
    const ratio = imgData.width / imgData.height;
    const w = pageWidth - 80;
    const h = w / ratio;
    pdf.addImage(imgData.data, 'PNG', 40, y, w, h);
    y += h + 20;
  }

  addHeading("Store Details");
  addField("Store ID", document.getElementById('storeId').value);
  addField("Retailer", document.getElementById('storeName').value);
  addField("Store Location", document.getElementById('storeLocation').value);
  addField("Team Member Name", document.getElementById('teamMember').value);

  addHeading("Devices Returned");
  const devicesChecked = Array.from(document.querySelectorAll('#devicesReturned input[type=checkbox]:checked')).map(cb => cb.value);
  devicesChecked.forEach(device => addField("Device", device));
  addField("Other Devices", document.getElementById('otherDevices').value);

  addHeading("Damage Information");
  addField("Any Devices Damaged", document.getElementById('damaged').value);

  y = await addImagesToPDF(document.getElementById('accessoryImage').files, pdf, "Device Images", pageWidth, y);
  y = await addImagesToPDF(document.getElementById('damageImages').files, pdf, "Damage Images", pageWidth, y);

  addHeading("Team Member Details");
  addField("Returned To", document.getElementById('storeMember').value);
  addField("Position", document.getElementById('storePosition').value);
  addField("Phone", document.getElementById('storePhone').value);

  addHeading("Store Team Member's Signature");
  if (!signaturePad.isEmpty()) {
    checkPageBreak(120);
    const sigData = signaturePad.toDataURL();
    pdf.addImage(sigData, 'PNG', 40, y, 200, 60);
    y += 80;
  }

  const dateTime = document.getElementById('returnDateTime').value;
  if (dateTime) {
    const formatted = new Date(dateTime).toLocaleString("en-NZ", {
      dateStyle: "short",
      timeStyle: "short"
    });
    addField("Date & Time of Return", formatted);
  }

  const storeId = document.getElementById('storeId').value || 'device-return';
  const fileName = `${storeId}-Device-Handover.pdf`;

  // Convert PDF to Blob for sharing or download
  const pdfBlob = pdf.output('blob');

  try {
    // Check if browser supports Web Share API with files
    if (navigator.share && navigator.canShare && navigator.canShare({ files: [new File([], '')] })) {
      const shareConfirm = confirm("✅ PDF generated successfully.\n\nWould you like to share it now?");
      if (shareConfirm) {
        const file = new File([pdfBlob], fileName, { type: 'application/pdf' });
        await navigator.share({
          title: 'Device Handover Form',
          text: 'Here is my Device Handover Form from ' + storeId,
          files: [file]
        });
        alert("✅ PDF shared successfully!");
        return; // Skip download if shared
      }
    }
  } catch (error) {
    console.error("Sharing failed:", error);
  }

  // Fallback: download if sharing not supported or declined
  pdf.save(fileName);
  alert(`✅ The PDF has been saved as "${fileName}".\n\nPlease message this PDF to you the Device Handovers chat manually.`);
}
